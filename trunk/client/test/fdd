#!/bin/sh -ef
# client/test/fdd - A part of Inquisitor project
# Copyright (C) 2004-2008 by Iquisitor team 
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# NAME=FDD read/write
# DESCRIPTION=Floppy drive read/write test
# DESTROYS_HDD=false
# IS_INTERACTIVE=true
# POWEROFF_DURING_TEST=false
# VERSION=0.1
# TAGS=fdd
# DEPENDS=Floppy
# VAR=FLOPPY_SIZE:int:1440:Size of testing floppy, KiB

. /usr/share/inquisitor/functions-test

exit_handler()
{
	[ -f "$TEST_IMAGE" ] && rm -f $TEST_IMAGE
	[ -f "$TEST_IMAGE"_fd ] && rm -f "$TEST_IMAGE"_fd
}

TEST_IMAGE=`mktemp`

test_fdd()
{
	local fdd=$1

	echo -n "Writing..."
	dd if=$TEST_IMAGE of=$fdd >$DEBUG_TTY 2>&1 || true
	echo_success

	# Clear all caches
	sync;sync;sync
	floppycontrol -f -d $fdd >/dev/null 2>&1 || true
	echo 3 > /proc/sys/vm/drop_caches

	echo -n "Reading and comparing..."
	dd if=$fdd of="$TEST_IMAGE"_fd bs=1024 count=$FLOPPY_SIZE \
		>$DEBUG_TTY 2>&1 || true
	diff "$TEST_IMAGE"_fd $TEST_IMAGE >/dev/null 2>&1 || return 1
	echo_success

	return 0
}

interactive()
{
	local fdd=$1
	local non_passed=1

	while ( [ "$non_passed" -eq 1 ] ); do
		require_attention
		print_green_message "Drive ${fdd}:"
		print_green_message "Either press y and insert floppy for testing, or n if you want to finish test: "
		read choice
		dismiss_attention

		if [ "$choice" = "n" ]; then
			test_failed "User cancelled test for $fdd"
			break
		fi

		test_fdd $fdd

		if [ $? -eq 0 ]; then
			print_green_message "Drive test passed"
			TESTED_QUANTITY=$(( $TESTED_QUANTITY + 1 ))
			test_progress $TESTED_QUANTITY $FDD_QUANTITY
			non_passed=0
		else
			print_red_message "Drive test failed!"
		fi
	done
}

FDD_QUANTITY=`get_fdds_list | wc -l`
if [ "$FDD_QUANTITY" -eq 0 ]; then
	test_succeeded "No FDDs found"
	exit 0
fi

# Generate test image
if dd if=/dev/urandom of=$TEST_IMAGE bs=1024 count=$FLOPPY_SIZE \
		>$DEBUG_TTY 2>&1; then
	true
else
	test_failed "Unable to create test image"
	exit 1
fi

TESTED_QUANTITY=0

for fdd in `get_fdds_list`; do
	interactive $fdd
done

test_succeeded
