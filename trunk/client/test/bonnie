#!/bin/sh -ef
# client/test/bonnie - A part of Inquisitor project
# Copyright (C) 2004-2008 by Iquisitor team 
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# NAME=Bonnie
# DESCRIPTION=Bonnie HDD performance benchmark
# DESTROYS_HDD=true
# POWEROFF_DURING_TEST=false
# VERSION=0.1
# TAGS=benchmark,hdd
# DEPENDS=HDD

. /usr/share/inquisitor/functions-test

exit_handler()
{
	[ -f "$RESULT_FILE" ] && rm -fr "$RESULT_FILE"
	if [ -d "$SCRATCH_DIRECTORY" ]; then
		umount -f $SCRATCH_DIRECTORY
		rmdir $SCRATCH_DIRECTORY
	fi
}

RESULT_FILE=`mktemp`
SCRATCH_DIRECTORY=`mktemp -d`

perform_benchmark()
{
	DRIVE=$1

	mke2fs -m0 -F $DRIVE >$DEBUG_TTY 2>&1
	mount $DRIVE $SCRATCH_DIRECTORY

	bonnie++ -u root -d $SCRATCH_DIRECTORY -s $TEST_FILE_SIZE \
		-n 1 -m benchmark > ${RESULT_FILE} 2>&1
	
	benchmark_submit_float "HDD $DRIVE output char speed" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $3}'`

	benchmark_submit_float "HDD $DRIVE output char CPU load" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $4}'`

	benchmark_submit_float "HDD $DRIVE output block speed" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $5}'`

	benchmark_submit_float "HDD $DRIVE output block CPU load" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $6}'`

	benchmark_submit_float "HDD $DRIVE rewrite speed" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $7}'`

	benchmark_submit_float "HDD $DRIVE rewrite CPU load" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $8}'`

	benchmark_submit_float "HDD $DRIVE input char speed" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $9}'`

	benchmark_submit_float "HDD $DRIVE input char CPU load" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $10}'`

	umount $SCRATCH_DIRECTORY
}

TOTAL_MEMORY=$(( `grep MemTotal /proc/meminfo | awk '{print $2}'` / 1024 ))
TEST_FILE_SIZE=$(($TOTAL_MEMORY * 2))

for BLOCK_DEV in `get_harddrives_list`; do
	echo -n "HDD $BLOCK_DEV"
	perform_benchmark $BLOCK_DEV
	echo_success
done

test_succeeded
