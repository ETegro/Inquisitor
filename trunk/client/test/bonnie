#!/bin/sh -ef
# NAME=Bonnie
# DESCRIPTION=This test uses bonnie++ benchmark to test hard drives (with ext2 filesystem) performance. There are two sections to the program's operations, but we are using only first one: the  IO throughput in a fashion that is designed to simulate some types of database applications. It uses double memory sized single test file. As a benchmark's results we get output/rewrite/input of char/block speed and CPU load.
# DESTROYS_HDD=true
# POWEROFF_DURING_TEST=false
# VERSION=0.1
# TAGS=benchmark,hdd
# DEPENDS=HDD

. /usr/share/inquisitor/functions-test

exit_handler()
{
	[ -f "$RESULT_FILE" ] && rm -fr "$RESULT_FILE"
	if [ -d "$SCRATCH_DIRECTORY" ]; then
		umount -f $SCRATCH_DIRECTORY
		rmdir $SCRATCH_DIRECTORY
	fi
}

RESULT_FILE=`mktemp`
SCRATCH_DIRECTORY=`mktemp -d`

perform_benchmark()
{
	DRIVE=$1

	mke2fs -m0 -F $DRIVE >$DEBUG_TTY 2>&1
	mount $DRIVE $SCRATCH_DIRECTORY

	bonnie++ -u root -d $SCRATCH_DIRECTORY -s $TEST_FILE_SIZE \
		-n 1 -m benchmark > ${RESULT_FILE} 2>&1
	
	benchmark_submit_float "HDD $DRIVE output char speed" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $3}'`

	benchmark_submit_float "HDD $DRIVE output char CPU load" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $4}'`

	benchmark_submit_float "HDD $DRIVE output block speed" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $5}'`

	benchmark_submit_float "HDD $DRIVE output block CPU load" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $6}'`

	benchmark_submit_float "HDD $DRIVE rewrite speed" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $7}'`

	benchmark_submit_float "HDD $DRIVE rewrite CPU load" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $8}'`

	benchmark_submit_float "HDD $DRIVE input char speed" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $9}'`

	benchmark_submit_float "HDD $DRIVE input char CPU load" \
	`sed -n '$p' < ${RESULT_FILE} | awk -F, '{print $10}'`

	umount $SCRATCH_DIRECTORY
}

TOTAL_MEMORY=$(( `grep MemTotal /proc/meminfo | awk '{print $2}'` / 1024 ))
TEST_FILE_SIZE=$(($TOTAL_MEMORY * 2))

for BLOCK_DEV in `get_harddrives_list`; do
	echo -n "HDD $BLOCK_DEV"
	perform_benchmark $BLOCK_DEV
	echo_success
done

test_succeeded
