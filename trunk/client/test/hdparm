#!/bin/sh -e
# NAME=Hdparm
# DESCRIPTION=Hdparm HDD speed benchmark
# VERSION=0.1
# TAGS=benchmark,hdd
# VAR=AVG_SAMPLES:int:5:Number of tests per disc to average for result

. /usr/share/inquisitor/functions-test

for UDI in `hal-find-by-property --key=storage.drive_type --string disk`; do
	BLOCK_DEV=`hal-get-property --udi "$UDI" --key block.device`

	echo -n "HDD $BLOCK_DEV "

	# Perform AVG_SAMPLES tests, calculate sum
	for i in `seq 1 $AVG_SAMPLES`; do
		BUFFERED=`hdparm -t $BLOCK_DEV | sed -ne '/Timing/ { s/^.*= *//; s, MB/sec,,; s/\.//; p }'`
		CACHED=`hdparm -T $BLOCK_DEV | sed -ne '/Timing/ { s/^.*= *//; s, MB/sec,,; s/\.//; p }'`
		BUFFERED_SUM=$(($BUFFERED_SUM + $BUFFERED))
		CACHED_SUM=$(($CACHED_SUM + $BUFFERED))
		echo -n '.'
	done

	# Convert to KB/s, calculate average
	BUFFERED_AVG=$(($BUFFERED_SUM * 10 / $AVG_SAMPLES))
	CACHED_AVG=$(($CACHED_SUM * 10 / $AVG_SAMPLES))

	# Report result
	echo " $BUFFERED_AVG / $CACHED_AVG KB/s"
done
