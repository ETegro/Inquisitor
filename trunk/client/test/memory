#!/bin/sh
# NAME=memory
# DESCRIPTION=Memory test
# DESTROYS_HDD=N
# IS_INTERACTIVE=N
# POWEROFF_DURING_TEST=N
# VERSION=0.1
# VAR=MEM_TEST_LOOPS:int:3:Testing loops
# VAR=MEM_LOG_TIME:int:30:Time between progress updates

. /usr/share/inquisitor/functions-test

TOTAL_MEMORY=$[(`cat /proc/meminfo | grep MemTotal | awk '{print $2}'` / 1024)-16]
TOTAL_SUBSTAGES=$((16 * MEM_TEST_LOOPS))
COMPLETED_SUBSTAGES=0
MEMORY_LOG=`mktemp`

test_started $TOTAL_SUBSTAGES

memtester $TOTAL_MEMORY $MEM_TEST_LOOPS > $MEMORY_LOG &
MEMTESTER_PID=`ps -ewf | grep 'memtester' | head -n1 | sed 's/^[^0-9]*\([0-9]\+\)[^0-9].*$/\1/'`

while true ; do
	sleep $MEM_LOG_TIME
	COMPLETED_SUBSTAGES=`cat $MEMORY_LOG | sed '{:loop g; n; s/^Loop\|Done/\0/; T loop; g; b nloop; :nloop n; s/^Loop\|Done/\0/; T nloop; g; b nloop; }' | grep -v '^$' | wc -l`
	if [ -d /proc/$MEMTESTER_PID ] ; then
		test_progress $COMPLETED_SUBSTAGES $TOTAL_SUBSTAGES
	else
		if [ "$COMPLETED_SUBSTAGES" -eq "$TOTAL_SUBSTAGES" ] ; then
			test_succeeded
			break
		else
			test_failed
		fi
	fi
done
