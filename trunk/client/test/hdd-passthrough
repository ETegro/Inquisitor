#!/bin/sh -e
# NAME=HDD passthrough disk
# DESCRIPTION=HDD passthrough disks test
# DESTROYS_HDD=true
# IS_INTERACTIVE=false
# POWEROFF_DURING_TEST=false
# VERSION=0.1
# TAGS=hdd
# VAR=DISK_GROUP_SIZE:int:8:Number of disks per group for testing

. /usr/share/inquisitor/functions-test

exit_handler()
{
	if [ -s "$FAILED_HDD" ]; then
		test_failed `cat $FAILED_HDD`
		rm $FAILED_HDD
	fi
}

FAILED_HDD=`mktemp`

raid-wizard-clear
$SHARE_DIR/hdd-badblocks.rb `get_harddrives_list`

I=0
while raid-wizard-passthrough $DISK_GROUP_SIZE $I; do
	$SHARE_DIR/hdd-badblocks.rb `get_harddrives_list` 5>$FAILED_HDD
	I=$(( $I + 1 ))
done

test_succeeded
