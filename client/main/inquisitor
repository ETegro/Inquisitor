#!/bin/sh -e
# client/main/inquisitor - A part of Inquisitor project
# Copyright (C) 2004-2008 by Iquisitor team 
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

. /etc/inquisitor/global
. $SHARE_DIR/functions
. $SHARE_DIR/communication
if [ -r $SHARE_DIR/init ] && ! [ -r /proc/cpuinfo ]; then
	. $SHARE_DIR/init
fi

# ===========================================================================
# Detects
# ===========================================================================

echo 'Starting detects'
inq-detect
echo 'Detects finished'

# ===========================================================================
# Self-identification
# ===========================================================================

echo 'Starting self-identification'
# Try various methods for self-id, stop after successful one
COMPUTER_ID=
for I in $SHARE_DIR/self-id/*; do
	echo -n "Trying self-id using $I"
	. $I
	if [ -n "$COMPUTER_ID" ]; then
		echo_success
		break
	else
		echo_failure
	fi
done
[ -n "$COMPUTER_ID" ] || fatal_failure 'Self-identification'
export COMPUTER_ID

# Reporting IP-address to the server
publish_my_ip || fatal_failure 'IP-address update'

# ===========================================================================
# Start logging
# ===========================================================================

hostname c$COMPUTER_ID
/sbin/service syslog-ng start || :

# ===========================================================================
# Set time
# ===========================================================================

echo -n 'Trying set local time '
if [ -n "$NTP_SERVER" ]; then
	if /usr/sbin/ntpdate $NTP_SERVER $1>/dev/null && /sbin/hwclock --systohc; then
		echo_success
	else
		echo_failure
	fi
else
	echo -n '(ntp server does not set)'
	echo_skipped
fi

# ===========================================================================
# Start watchdog, if available
# ===========================================================================

watchdog_start

# ===========================================================================
# Submit configuration by REST
# ===========================================================================

submit_components $HOME/components.xml

# ===========================================================================
# Run all tests
# ===========================================================================

plan_test_script
. $HOME/test_script

# We completed all tests
print_green_message "================"
print_green_message "TESTING FINISHED"
print_green_message "================"

testing_finished

bash
